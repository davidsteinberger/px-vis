<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-colors-design/colors.html"/>
<link rel="import" href="px-vis-behavior-common.html"/>
<link rel="import" href="px-vis-behavior-datetime.html"/>
<link rel="import" href="px-vis-register-item.html"/>
<link rel="import" href="px-vis-register-datetime.html"/>
<link rel="import" href="../numbro-element/numbro-element.html" />
<link rel="import" href="../px-tooltip/px-tooltip.html"/>

<!--
Element providing a display and interaction space for series in your chart.

It can be either vertical on the side of the chart or horizonal above or below your chart.
It displays a colored bar matching the series color and the series name.
When you hover over the chart, the chart sends data to the register via the bound "tooltipData" property.
These data values are then displayed in the register.

You can turn series on the chart off by clicking on that series in the register.

##### Usage

    <px-vis-register
        height="50"
        use-percentage="true"
        width="[[width]]"
        type="horizontal"
        tooltip-data=[[tooltipData]]
        muted-series="[[mutedSeries]]"
        complete-series-config="[[completeSeriesConfig]]"
        chart-data="[[chartData]]"
        x-axis-type="time"
        muted-series="{{mutedSeries}}">
    </px-vis-register>


##### Sending Data to the Register
tooltipData is in the form:

    {
        'time': d3TimeStamp,
        'series': [
            {'name':'seriesName0','value': seriesVal0 },
            {'name':'seriesName1','value': seriesVal1 }
        ]
    }

When not hovering on a chart, the tooltipData should still have the series names in order for them to still appear in the register. IE:

    {
        'time': null,
        'series': [
            {'name':'seriesName0','value': null },
            {'name':'seriesName1','value': null }
        ]
    }

##### Reporting Data from the Register
The component returns an object via mutedSeries which the chart can take and react to:

    {
        'seriesId1':true,
        'seriesId2':false,
    }

##### Time, number, and name formatting
Formatting for the timestamps,the data values, and the series names can be controlled via a series of properties.
Please see the properties for configuration details.

@element px-vis-register
@blurb Element providing a display and interaction space for series in your chart.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-vis-register">

  <link rel="import" type="css" href="css/px-vis-register.css"/>

  <template>

    <div
      id="registerWrap"
      class="inline--flex flex--col"
      style$="height:{{height}}px; width:[[width]]px">

      <template is="dom-if" if="{{_isOfType(xAxisType,'time')}}">
        <px-vis-register-datetime
          first-date-time="[[_firstDateTime]]"
          second-date-time="[[_secondDateTime]]"
          separator="[[_separator]]"
          x-axis-type="[[xAxisType]]"
        ></px-vis-register-datetime>
      </template>

      <div class$="{{_getSeriesWrapperClass(type)}}">
        <template is="dom-if" if="{{!_isOfType(xAxisType, 'pie')}}">
          <template is="dom-repeat" items="{{_series}}">
            <px-vis-register-item
              item="[[item]]"
              complete-series-config="[[completeSeriesConfig]]"
              chart-data="[[chartData]]"
              type="[[type]]"
              x-axis-type="[[xAxisType]]"
              y-axis-type="[[yAxisType]]">
            </px-vis-register-item>
          </template>
        </template>
        <!-- For pie charts -->
        <template is="dom-if" if="{{_isOfType(yAxisType, 'pie')}}">
          <h1>PIE</h1>
          <!--
          <px-vis-register-item-pie>
          </px-vis-register-item-pie>
          -->
        </template>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-register',

    behaviors: [
      PxVisBehavior.sizing,
      PxVisBehavior.formatting,
      PxVisBehaviorTime.datetime,
      PxVisBehavior.mutedSeries,
      PxVisBehavior.tooltipData,
      PxVisBehavior.dataset,
      PxVisBehavior.axisTypes,
      PxVisBehavior.completeSeriesConfig,
      PxVisBehavior.commonMethods,
      commonColors
    ],

    /**
     * Properties block, expose attribute values to the DOM via 'reflect'
     *
     * @property properties
     * @type Object
     */
    properties: {
      /**
       * Defines if the register should be horizontal or vertical. Options are:
       *  - `vertical`
       *  - `horizontal`
       *
       * @property type
       * @type string
       * @default vertical
      */
      type:{
       type:String,
       value:"vertical",
       notify: true
      },

      _series: {
        type: Array,
        computed: '_computeSeries(tooltipData)'
      },



      /**
       * Holder for the formated first datetime string
       *
       * @property _firstDateTime
       * @type string
      */
      _firstDateTime:{
        type:String,
        notify:true
      },
      /**
       * Holder for the formated second datetime string
       *
       * @property _secondDateTime
       * @type string
      */
      _secondDateTime:{
        type:String,
        notify:true
      },
      /**
       * Holder for the formated separator character
       *
       * @property _separator
       * @type string
      */
      _separator:{
        type:String,
        notify:true
      },
      /**
       * For pie charts whether the values should be displayed in %
       */
      usePercentage: {
        type: Boolean,
        value: false
      }
    },

    observers: [
      '_formatDateTime(tooltipData.*)',
      '_toggleSeries(mutedSeries.*)'
     ],

     ready: function() {
       console.log(this.completeSeriesConfig);
     },

     _getSeriesWrapperClass: function(type) {
       var classList = 'flex ';
       if(type === 'horizontal') {
         classList += 'flex--row ';
       } else {
         classList += 'flex--col';
       }
       return classList;
     },

    /**
     * dom-if function for type property which returns true if type equals horizontal
     *
     * `type` is dev set type property.
     *
     * `bool` is true if type === 'horizontal'; false if not
     *
     * @method _typeEqualHorizontal
     * @param {type}
     * @return {bool}
     */
    _typeEqualHorizontal: function(type) {
      return type === 'horizontal';
    },

    /**
     * Function which takes the incoming datetime from tooltipData and formats it.
     *
     * Returns set values via setting helper properties used in the html.
     *
     * @method _formatDateTime
     */
    _formatDateTime: function() {
      if(this.tooltipData.time) {
        var momentObj1 = this.formatTimestamp(
          this.tooltipData.time,
          this.timezone,
          this.firstDateTimeFormat
        );
        var momentObj2 = this.formatTimestamp(
          this.tooltipData.time,
          this.timezone,
          this.secondDateTimeFormat
        );
        this.set('_firstDateTime', momentObj1);
        this.set('_secondDateTime', momentObj2);
        this.set('_separator', this.separator);

      } else {
        this.set('_firstDateTime', '');
        this.set('_secondDateTime', '');
        this.set('_separator', '');
      }
    },

    /**
     * observer function which is fired when the mutedSeries property is changed.
     *
     * Adds or removes muted class to those series in the register.
     *
     * @method _toggleSeries
     */
    _toggleSeries: function() {
      // find all series with name and toggle class
      var keys = Object.keys(this.mutedSeries),
          i,
          len = keys.length,
          series;

      for(i = 0; i < len; i++) {
        series = this.$$('.series[name=R' + keys[i] + ']');
        this.toggleClass('muted', this.mutedSeries[keys[i]], series);
      }
    },
    _returnPieVal: function(item, axis, separator, usePercentage) {
      //pie should have only one config bit.
      var key = Object.keys(this.completeSeriesConfig)[0],
          axisKey = axis === 'x' ? this.completeSeriesConfig[key]['x'] : this.completeSeriesConfig[key]['y'],
          axisKey = usePercentage ? 'percentage' : axisKey;

      if(item && item[axisKey]) {
        return item[axisKey] + (separator ? separator : '');
      }
      return null;
    },
    _isOfType: function(toTest, type) {
      console.log(toTest)
      console.log(type)
      return toTest === type;
    },
    _getXUnit: function(item, completeSeriesConfig) {
      return this.completeSeriesConfig[item.name].xAxisUnit ? this.completeSeriesConfig[item.name].xAxisUnit : '';
    },
    _getYUnit: function(item, completeSeriesConfig) {
      return this.completeSeriesConfig[item.name] && this.completeSeriesConfig[item.name].yAxisUnit ? this.completeSeriesConfig[item.name].yAxisUnit : '';
    },
    _getPieUnit: function(usePercentage) {
      //pie should have only one config bit.
      var key = Object.keys(this.completeSeriesConfig)[0];
      var unit = this.completeSeriesConfig[key].xAxisUnit;
      return usePercentage ? '%' : unit;
    },
    _getPieBackColor: function(item, index) {
      return item.backgroundColor ? item.backgroundColor : this._getPieColorForIndex(index);
    },
    _computeSeries: function() {
      return this.tooltipData.series;
    }
  });
</script>
